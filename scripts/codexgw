#!/bin/bash
#
# codexgw - Launch Codex CLI with Fabric MCP Server
#
# Usage: codexgw
#

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PROJECT_DIR="/Users/MAC/Documents/MCP_Cloud_Fabric"
VENV_PYTHON="${PROJECT_DIR}/venv/bin/python"

echo -e "${BLUE}ðŸš€ Fabric AI Gateway - Codex CLI${NC}"
echo ""

# Check if venv exists
if [ ! -f "$VENV_PYTHON" ]; then
    echo "Error: Virtual environment not found at $PROJECT_DIR/venv"
    exit 1
fi

# Check Codex CLI
if ! command -v codex &> /dev/null; then
    echo "Error: Codex CLI not found"
    echo "Install with: brew install codex  OR  npm install -g @openai/codex"
    exit 1
fi

# Update Codex MCP config
CODEX_CONFIG_DIR="${HOME}/.codex"
mkdir -p "$CODEX_CONFIG_DIR"

CONFIG_FILE="${CODEX_CONFIG_DIR}/config.toml"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Codex config not found at $CONFIG_FILE"
    echo "Please run 'codex' once to create the configuration file"
    exit 1
fi

# Backup existing config
BACKUP_FILE="${CONFIG_FILE}.bak.$(date +%Y%m%d_%H%M%S)"
cp "$CONFIG_FILE" "$BACKUP_FILE"
echo "Created backup: $BACKUP_FILE"

# Update config using Python
python3 << PYTHON
import re
import pathlib

config_path = pathlib.Path("$CONFIG_FILE")
project_dir = "$PROJECT_DIR"
text = config_path.read_text(encoding="utf-8")

server_name = "fabric_gateway"

# Pattern to match existing server config block
pattern = re.compile(
    rf"(?ms)^\[mcp_servers\.{re.escape(server_name)}\]\n.*?(?=^\[|\Z)"
)

# New config block
new_block = f'''[mcp_servers.{server_name}]
command = "{project_dir}/venv/bin/python"
args = ["-m", "src.mcp_server"]
cwd = "{project_dir}"
enabled = true
'''

# Check if block exists
match = pattern.search(text)
if match:
    text = text[:match.start()] + new_block + "\n" + text[match.end():]
else:
    text = text.rstrip() + "\n\n" + new_block + "\n"

config_path.write_text(text, encoding="utf-8")
print(f"Updated MCP server 'fabric_gateway' in {config_path}")
PYTHON

echo -e "${GREEN}âœ“ MCP Server configured${NC}"
echo ""
echo -e "${YELLOW}Tips:${NC}"
echo "  - Type /mcp to verify connection"
echo "  - Ask: 'List my Power BI workspaces'"
echo "  - Ask: 'Show tables in dataset X'"
echo ""
echo -e "${BLUE}Launching Codex CLI...${NC}"
echo ""

# Launch Codex
exec codex
